<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"/> <meta http-equiv="X-UA-Compatible" content="IE=edge"/> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> <meta name="viewport" content="width=device-width, initial-scale=1"/> <meta name="flattr:id" content="e7nqg5"/> <title>Code Structure | Marlin Firmware</title> <meta name="generator" content="Jekyll v3.9.0"/> <meta property="og:title" content="Code Structure"/> <meta name="author" content="thinkyhead"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="An overview of Marlin’s files and folders."/> <meta property="og:description" content="An overview of Marlin’s files and folders."/> <link rel="canonical" href="https://marlinfw.org/docs/development/code_structure.html"/> <meta property="og:url" content="https://marlinfw.org/docs/development/code_structure.html"/> <meta property="og:site_name" content="Marlin Firmware"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2024-02-07T22:52:35-06:00"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Code Structure"/> <meta name="twitter:site" content="@MarlinFirmware"/> <meta name="twitter:creator" content="@thinkyhead"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"thinkyhead"},"dateModified":"2024-02-07T22:52:35-06:00","datePublished":"2024-02-07T22:52:35-06:00","description":"An overview of Marlin’s files and folders.","headline":"Code Structure","mainEntityOfPage":{"@type":"WebPage","@id":"https://marlinfw.org/docs/development/code_structure.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://marlinfw.org/assets/images/logo/marlin/small.png"},"name":"thinkyhead"},"url":"https://marlinfw.org/docs/development/code_structure.html"}</script> <link rel="icon" href="/assets/favicon_m.ico"/> <link rel="stylesheet" href="/assets/stylesheets/main.css"/> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--> <script src="/assets/javascript/head.min.js"></script> <script type="text/javascript">

      /**
       * As Github pages do not support https for custom domains
       * this is the current best workaround for #18.
       */
      var domains  = [ 'marlinfw.org', 'localhost', '127.0.0.1' ];
      var pathname = location.pathname.replace(/^\/MarlinDocumentation/, '')
      if (domains.indexOf(window.location.hostname) == -1)
        window.top.location.href = 'https://marlinfw.org' + pathname;

      /**
       * Another ugly workaround trying to improve UX reported by #35
       */
      if (location.protocol != 'https:' && window.location.hostname == 'marlinfw.org')
        location.href = 'https:' + window.location.href.substring(window.location.protocol.length);

      /**
       * Improves overall speed by loading javascript and css resources in parallel
       * with the main page.
       */
      head.load(
          "/assets/stylesheets/fontawesome.min.css",
          "/assets/stylesheets/solid.min.css",
          "/assets/stylesheets/brands.min.css",

          "/assets/javascript/jquery-2.2.1.min.js",
          "/assets/javascript/jquery-ui.min.js",
          "/assets/javascript/bootstrap.min.js",
          "/assets/javascript/tocify.min.js",
          "/assets/javascript/search.js",
          "/assets/javascript/custom.js",

          "/assets/javascript/sheetrock.min.js",
          "/assets/javascript/cookieconsent.min.js"
      );

      head.ready(function() {
        window.cookieconsent_options = {
          "message":"We use cookies to ensure you get the best experience on our website",
          "dismiss": "Got it!", "learnMore": "More info", "link":"", "theme": "dark-bottom"
        };
      });
    </script> </head> <body role="document"> <nav class="navbar navbar-default navbar-fixed-top custom-no-margin"> <div class="container"> <div class="navbar-header"> <img id="daynite" src="/assets/images/btn-night.svg" alt="Dark Mode" width="32" height="32"> <a href="/" class="navbar-brand"> <svg id="mflogo" height="95%" version="1.1" viewbox="0 0 828.26325 270.80054"> <g id="g981"> <path d="M 69.48788,0 C 31.1751,0 0,32.61059 0,72.74045 V 198.055 c 0,40.12987 31.17607,72.74553 69.48788,72.74553 H 758.7735 c 38.3127,0 69.4898,-32.61566 69.4898,-72.74553 V 5.84382 c -0.019,-3.60102 -2,-5.68155 -6.9765,-5.84159 H 220.29327 Z m 0,21.01625 H 682.6259 c 8.157,0.43104 14.4593,1.90061 18.9474,6.50681 7.8555,8.06197 84.9293,82.07514 102.73,100.35813 1.8839,1.93509 3.8964,6.37495 3.8964,11.50813 v 58.66132 c 0,28.84892 -21.8776,51.7242 -49.4209,51.7242 H 69.4932 c -27.54239,0 -49.42089,-22.87528 -49.42089,-51.7242 V 72.73609 c 0,-0.90162 0.0193,-1.79645 0.0619,-2.6858 1.30928,-27.57002 22.67685,-49.0386 49.35799,-49.0386 z" fill="#0000ff" id="path957" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 539.5917,36.40978 -0.068,135.74053 c 0,17.73633 5.7753,32.12681 17.3285,43.16739 11.7332,11.22111 26.2205,18.88542 44.6327,18.88542 1.6257,0 4.7893,-0.14503 4.7893,-0.14503 v -30.53858 c -1.4629,0.1785 -2.9571,-0.0101 -4.5172,-0.0101 -9.3867,0 -16.3858,-3.57688 -22.162,-9.36867 -5.7765,-5.79149 -8.6669,-13.38947 -8.6617,-22.80124 l 0.068,-134.92917 z" fill="#0000ff" id="path965" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 48.89544,88.53966 c 0,-15.02233 5.05444,-27.69172 15.1637,-38.00816 10.10849,-10.31644 22.56459,-15.47466 37.36638,-15.47466 6.85957,0 12.81609,0.99594 17.8713,2.98631 5.23501,1.6288 9.65764,3.80061 13.268,6.51552 3.24931,1.99088 6.40833,4.52476 9.47717,7.60143 l 5.957,5.70143 c 1.26361,-1.62891 2.34665,-2.89595 3.24921,-3.80092 1.08314,-1.086 2.07599,-1.99087 2.97855,-2.71481 1.62466,-1.6289 5.77653,-4.70578 12.45611,-9.23064 6.67909,-4.70548 15.8856,-7.05832 27.61884,-7.05832 14.44084,0 26.89694,5.15812 37.36638,15.47466 10.4704,10.31644 15.70464,22.98583 15.70464,38.00816 V 234.05708 H 212.17203 V 90.71005 c 0,-6.3347 -2.52722,-11.94525 -7.58166,-16.83268 -4.87396,-4.88662 -10.6504,-7.32972 -17.32939,-7.32972 -6.49862,0 -11.9142,2.26207 -16.24655,6.78662 -4.33235,4.34371 -6.49852,10.13551 -6.49852,17.37527 V 234.05657 H 129.58617 V 90.70954 c 0,-5.97283 -2.16617,-11.49291 -6.49862,-16.56087 -4.33235,-5.06765 -9.47707,-7.60143 -15.43369,-7.60143 -5.95661,0 -11.46325,2.53378 -16.5175,7.60143 -4.69339,5.06735 -7.04013,10.58825 -7.04013,16.56087 V 234.05657 H 56.2045 c -4.86419,0 -7.30897,-2.56065 -7.30897,-7.68216 z" fill="#0000ff" id="path971" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 325.92573,233.97594 c -14.76501,0.48682 -35.97484,-4.07232 -49.33284,-17.10347 -13.35799,-13.21198 -20.03699,-29.59131 -20.03699,-49.13799 0,-19.90874 6.85957,-36.74041 20.5789,-50.49499 13.71933,-13.75458 30.5074,-20.63288 50.36439,-20.63288 19.857,0 36.19355,6.87749 49.00963,20.63288 12.81706,13.75458 19.2251,31.67347 19.2251,53.75362 v 62.98384 h -31.68024 v -61.89764 c 0,-13.39352 -3.42988,-24.07203 -10.28944,-32.03452 -6.85967,-8.14463 -15.9756,-12.21705 -27.34789,-12.21705 -10.28945,0 -19.1351,3.80082 -26.536,11.40265 -7.40118,7.60153 -11.10134,16.55986 -11.10134,26.8763 0,11.04058 3.88112,20.36108 11.64325,27.96251 7.9427,7.60143 19.68959,9.79078 29.32391,9.40397 h 21.93269 v 30.53857 z" fill="#0000ff" id="path969" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 467.4988,98.58024 c -18.4123,0 -33.485,5.60873 -45.2182,16.82963 -11.5533,11.04059 -17.32847,25.43006 -17.32847,43.16639 v 75.47169 h 31.40927 v -74.65831 c 0,-9.41137 2.8852,-17.01117 8.6617,-22.80327 5.7765,-5.79179 13.3609,-8.68875 22.7475,-8.68875 9.0258,0 16.4265,2.98682 22.2036,8.95975 5.9571,5.97231 8.934,13.48176 8.934,22.53146 l -0.1529,1.81451 h 31.4092 l 0.1529,-2.62779 c 1.04,-17.88441 -5.8668,-32.39761 -17.6003,-43.43718 -11.7332,-11.04058 -26.806,-16.55884 -45.2182,-16.55884 z" fill="#0000ff" id="path967" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 656.9725,158.62088 c 0,-17.73633 5.7765,-32.1258 17.3294,-43.16537 11.7332,-11.22111 26.8069,-16.83166 45.2192,-16.83166 18.4122,0 33.4859,5.52009 45.2191,16.55986 11.7333,11.04058 17.6004,25.5193 17.6004,43.43717 v 67.58629 c -0.039,5.32475 -2.4795,7.8854 -7.4874,7.8854 h -23.9223 v -74.65729 c 0,-9.0493 -2.9785,-16.55986 -8.9355,-22.53248 -5.7766,-5.97262 -13.178,-8.95893 -22.2037,-8.95893 -9.3869,0 -16.9684,2.89564 -22.7446,8.68723 -5.7765,5.79179 -8.6648,13.39352 -8.6648,22.80428 v 74.65729 h -31.4092 z" fill="#0000ff" id="path959" style="fill-opacity:1;stroke:none;stroke-width:0.999984" class="logo"></path> <path d="m 616.136,92.69788 h 31.6802 l 10e-5,-15.49698 v -4.28763 c 0,-8.585 -6.4197,-15.49596 -14.3934,-15.49596 h -2.8932 c -7.9741,0 -14.3934,6.91137 -14.3934,15.49596 v 4.28763 z" color="#000000" color-rendering="auto" enable-background="accumulate" fill="#0000ff" fill-rule="evenodd" image-rendering="auto" shape-rendering="auto" solid-color="#000000" style="fill-opacity:1;stroke:none;stroke-width:0.999984" id="path961" class="logo"></path> <path d="m 616.136,100.71006 h 31.6802 V 234.00637 H 616.136 Z" color="#000000" color-rendering="auto" enable-background="accumulate" fill="#0000ff" fill-rule="evenodd" image-rendering="auto" shape-rendering="auto" solid-color="#000000" style="fill-opacity:1;stroke:none;stroke-width:0.999984" id="path963" class="logo"></path> </g> </svg> </a> <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> </div> <div class="navbar-collapse collapse" id="navbar-main"> <ul class="nav navbar-nav"> <li id="top-intro"><a href="/docs/basics/introduction.html">About Marlin</a></li> <li id="top-download"><a href="/meta/download/">Download</a></li> <li id="top-config"><a href="/docs/configuration/configuration.html">Configure</a></li> <li id="top-install"><a href="/docs/basics/install.html">Install</a></li> <li id="top-tools" class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="navbar-tools">Tools <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/tools/u8glib/converter.html">Bitmap Converter</a></li> <li><a href="/tools/rgb565/converter.html">RGB565 Converter</a></li> <li><a href="/tools/lin_advance/k-factor.html">Calibrate Linear Advance</a></li> <li><a href="/tools/input_shaping/freq-calibr.html">Calibrate Input Shaping</a></li> <li class="divider"> <li><a href="//github.com/MarlinFirmware/Marlin/issues">Bugtracker</a></li> <li><a href="/docs/basics/reporting_bugs.html">Reporting bugs</a></li> <li class="divider"> <li><a href="//github.com/MarlinFirmware/Marlin">Source Code Repository</a></li> </ul> </li> <li id="top-help" class="dropdown"> <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="navbar-documentation">Help <span class="caret"></span></a> <ul class="dropdown-menu"> <li class="dropdown-submenu configuration"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Configuration</a> <ul class="dropdown-menu"> <li><a href="/meta/configuration/">All documents</a></li> <li class="divider"> <li><a href="/docs/configuration/1.1/laser_spindle.html">Laser/Spindle Configuration (1.1.x)</a></li> <li><a href="/docs/configuration/2.0.9/laser_spindle.html">Laser/Spindle Configuration (2.0.9.x)</a></li> <li><a href="/docs/configuration/config-ini.html">Configuring with INI</a></li> <li><a href="/docs/configuration/configuration.html">Configuring Marlin</a></li> <li><a href="/docs/configuration/probes.html">Probe Configuration</a></li> </ul> </li> <li class="dropdown-submenu development"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Development</a> <ul class="dropdown-menu"> <li><a href="/meta/development/">All documents</a></li> <li class="divider"> <li><a href="/docs/development/boards.html">Boards</a></li> <li class="divider"> <li><a href="/docs/development/code_structure.html">Code Structure</a></li> <li><a href="/docs/development/coding_standards.html">Coding Standards</a></li> <li><a href="/docs/development/fastio.html">FastIO</a></li> <li><a href="/docs/development/hal.html">Hardware Abstraction Layer</a></li> <li class="divider"> <li><a href="/docs/development/contributing.html">Contributing to Marlin</a></li> <li class="divider"> <li><a href="/docs/development/feature_request.html">Feature requests</a></li> <li><a href="/docs/development/getting_started_pull_requests.html">Contributing Code with Pull Requests</a></li> <li><a href="/docs/development/git_scripts.html">Marlin Github Scripts</a></li> <li class="divider"> <li><a href="/docs/development/fonts.html">Adding new fonts</a></li> <li><a href="/docs/development/lcd_language.html">LCD Language System</a></li> </ul> </li> <li class="dropdown-submenu features"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Features</a> <ul class="dropdown-menu"> <li><a href="/meta/features/">All documents</a></li> <li class="divider"> <li><a href="/docs/features/auto_bed_leveling.html">Automatic Bed Leveling</a></li> <li><a href="/docs/features/unified_bed_leveling.html">Unified Bed Leveling</a></li> <li class="divider"> <li><a href="/docs/features/autostart.html">Autostart</a></li> <li class="divider"> <li><a href="/docs/features/eeprom.html">EEPROM</a></li> <li class="divider"> <li><a href="/docs/features/fwretract.html">Firmware Retract</a></li> <li><a href="/docs/features/input_shaping.html">Input Shaping</a></li> <li><a href="/docs/features/lin_advance.html">Linear Advance</a></li> <li><a href="/docs/features/model_predictive_control.html">Model Predictive Temperature Control</a></li> <li><a href="/docs/features/probe_temp_compensation.html">Probe Temperature Compensation</a></li> <li class="divider"> <li><a href="/docs/features/lcd_menu.html">LCD Menu Tree</a></li> </ul> </li> <li class="dropdown-submenu gcode"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">G-code</a> <ul class="dropdown-menu"> <li><a href="/meta/gcode/">All documents</a></li> <li class="divider"> <li><a href="/docs/gcode/G000-G001.html"><strong>G0-G1</strong>: Linear Move</a></li> <li><a href="/docs/gcode/G002-G003.html"><strong>G2-G3</strong>: Arc or Circle Move</a></li> <li><a href="/docs/gcode/G004.html"><strong>G4</strong>: Dwell</a></li> <li><a href="/docs/gcode/G005.html"><strong>G5</strong>: Bézier cubic spline</a></li> <li><a href="/docs/gcode/G006.html"><strong>G6</strong>: Direct Stepper Move</a></li> <li><a href="/docs/gcode/G010.html"><strong>G10</strong>: Retract</a></li> <li><a href="/docs/gcode/G011.html"><strong>G11</strong>: Recover</a></li> <li><a href="/docs/gcode/G012.html"><strong>G12</strong>: Clean the Nozzle</a></li> <li><a href="/docs/gcode/G017-G019.html"><strong>G17-G19</strong>: CNC Workspace Planes</a></li> <li><a href="/docs/gcode/G020.html"><strong>G20</strong>: Inch Units</a></li> <li><a href="/docs/gcode/G021.html"><strong>G21</strong>: Millimeter Units</a></li> <li><a href="/docs/gcode/G026.html"><strong>G26</strong>: Mesh Validation Pattern</a></li> <li><a href="/docs/gcode/G027.html"><strong>G27</strong>: Park toolhead</a></li> <li><a href="/docs/gcode/G028.html"><strong>G28</strong>: Auto Home</a></li> <li><a href="/docs/gcode/G029.html"><strong>G29</strong>: Bed Leveling</a></li> <li><a href="/docs/gcode/G029-abl-3point.html"><strong>G29</strong>: Bed Leveling (3-Point)</a></li> <li><a href="/docs/gcode/G029-abl-linear.html"><strong>G29</strong>: Bed Leveling (Linear)</a></li> <li><a href="/docs/gcode/G029-mbl.html"><strong>G29</strong>: Bed Leveling (Manual)</a></li> <li><a href="/docs/gcode/G029-abl-bilinear.html"><strong>G29</strong>: Bed Leveling (Bilinear)</a></li> <li><a href="/docs/gcode/G029-ubl.html"><strong>G29</strong>: Bed Leveling (Unified)</a></li> <li><a href="/docs/gcode/G030.html"><strong>G30</strong>: Single Z-Probe</a></li> <li><a href="/docs/gcode/G031.html"><strong>G31</strong>: Dock Sled</a></li> <li><a href="/docs/gcode/G032.html"><strong>G32</strong>: Undock Sled</a></li> <li><a href="/docs/gcode/G033.html"><strong>G33</strong>: Delta Auto Calibration</a></li> <li><a href="/docs/gcode/G034-zsaa.html"><strong>G34</strong>: Z Steppers Auto-Alignment</a></li> <li><a href="/docs/gcode/G034-mgc.html"><strong>G34</strong>: Mechanical Gantry Calibration</a></li> <li><a href="/docs/gcode/G035.html"><strong>G35</strong>: Tramming Assistant</a></li> <li><a href="/docs/gcode/G038.html"><strong>G38.2-G38.5</strong>: Probe target</a></li> <li><a href="/docs/gcode/G042.html"><strong>G42</strong>: Move to mesh coordinate</a></li> <li><a href="/docs/gcode/G053.html"><strong>G53</strong>: Move in Machine Coordinates</a></li> <li><a href="/docs/gcode/G054-G059.html"><strong>G54-G59.3</strong>: Workspace Coordinate System</a></li> <li><a href="/docs/gcode/G060.html"><strong>G60</strong>: Save Current Position</a></li> <li><a href="/docs/gcode/G061.html"><strong>G61</strong>: Return to Saved Position</a></li> <li><a href="/docs/gcode/G076.html"><strong>G76</strong>: Probe temperature calibration</a></li> <li><a href="/docs/gcode/G080.html"><strong>G80</strong>: Cancel Current Motion Mode</a></li> <li><a href="/docs/gcode/G090.html"><strong>G90</strong>: Absolute Positioning</a></li> <li><a href="/docs/gcode/G091.html"><strong>G91</strong>: Relative Positioning</a></li> <li><a href="/docs/gcode/G092.html"><strong>G92</strong>: Set Position</a></li> <li><a href="/docs/gcode/G425.html"><strong>G425</strong>: Backlash Calibration</a></li> <li><a href="/docs/gcode/M000-M001.html"><strong>M0-M1</strong>: Unconditional stop</a></li> <li><a href="/docs/gcode/M003.html"><strong>M3</strong>: Spindle CW / Laser On</a></li> <li><a href="/docs/gcode/M004.html"><strong>M4</strong>: Spindle CCW / Laser On</a></li> <li><a href="/docs/gcode/M005.html"><strong>M5</strong>: Spindle / Laser Off</a></li> <li><a href="/docs/gcode/M007-M009.html"><strong>M7-M9</strong>: Coolant Controls</a></li> <li><a href="/docs/gcode/M010-M011.html"><strong>M10-M11</strong>: Vacuum / Blower Control</a></li> <li><a href="/docs/gcode/M016.html"><strong>M16</strong>: Expected Printer Check</a></li> <li><a href="/docs/gcode/M017.html"><strong>M17</strong>: Enable Steppers</a></li> <li><a href="/docs/gcode/M018.html"><strong>M18, M84</strong>: Disable steppers</a></li> <li><a href="/docs/gcode/M020.html"><strong>M20</strong>: List SD Card</a></li> <li><a href="/docs/gcode/M021.html"><strong>M21</strong>: Init SD card</a></li> <li><a href="/docs/gcode/M022.html"><strong>M22</strong>: Release SD card</a></li> <li><a href="/docs/gcode/M023.html"><strong>M23</strong>: Select SD file</a></li> <li><a href="/docs/gcode/M024.html"><strong>M24</strong>: Start or Resume SD print</a></li> <li><a href="/docs/gcode/M025.html"><strong>M25</strong>: Pause SD print</a></li> <li><a href="/docs/gcode/M026.html"><strong>M26</strong>: Set SD position</a></li> <li><a href="/docs/gcode/M027.html"><strong>M27</strong>: Report SD print status</a></li> <li><a href="/docs/gcode/M028.html"><strong>M28</strong>: Start SD write</a></li> <li><a href="/docs/gcode/M029.html"><strong>M29</strong>: Stop SD write</a></li> <li><a href="/docs/gcode/M030.html"><strong>M30</strong>: Delete SD file</a></li> <li><a href="/docs/gcode/M031.html"><strong>M31</strong>: Print time</a></li> <li><a href="/docs/gcode/M032.html"><strong>M32</strong>: Select and Start</a></li> <li><a href="/docs/gcode/M033.html"><strong>M33</strong>: Get Long Path</a></li> <li><a href="/docs/gcode/M034.html"><strong>M34</strong>: SDCard Sorting</a></li> <li><a href="/docs/gcode/M042.html"><strong>M42</strong>: Set Pin State</a></li> <li><a href="/docs/gcode/M043.html"><strong>M43</strong>: Debug Pins</a></li> <li><a href="/docs/gcode/M043-T.html"><strong>M43 T</strong>: Toggle Pins</a></li> <li><a href="/docs/gcode/M048.html"><strong>M48</strong>: Probe Repeatability Test</a></li> <li><a href="/docs/gcode/M073.html"><strong>M73</strong>: Set Print Progress</a></li> <li><a href="/docs/gcode/M075.html"><strong>M75</strong>: Start Print Job Timer</a></li> <li><a href="/docs/gcode/M076.html"><strong>M76</strong>: Pause Print Job Timer</a></li> <li><a href="/docs/gcode/M077.html"><strong>M77</strong>: Stop Print Job Timer</a></li> <li><a href="/docs/gcode/M078.html"><strong>M78</strong>: Print Job Stats</a></li> <li><a href="/docs/gcode/M080.html"><strong>M80</strong>: Power On</a></li> <li><a href="/docs/gcode/M081.html"><strong>M81</strong>: Power Off</a></li> <li><a href="/docs/gcode/M082.html"><strong>M82</strong>: E Absolute</a></li> <li><a href="/docs/gcode/M083.html"><strong>M83</strong>: E Relative</a></li> <li><a href="/docs/gcode/M085.html"><strong>M85</strong>: Inactivity Shutdown</a></li> <li><a href="/docs/gcode/M086.html"><strong>M86</strong>: Hotend Idle Timeout</a></li> <li><a href="/docs/gcode/M087.html"><strong>M87</strong>: Disable Hotend Idle Timeout</a></li> <li><a href="/docs/gcode/M092.html"><strong>M92</strong>: Set Axis Steps-per-unit</a></li> <li><a href="/docs/gcode/M100.html"><strong>M100</strong>: Free Memory</a></li> <li><a href="/docs/gcode/M102.html"><strong>M102</strong>: Configure Bed Distance Sensor</a></li> <li><a href="/docs/gcode/M104.html"><strong>M104</strong>: Set Hotend Temperature</a></li> <li><a href="/docs/gcode/M105.html"><strong>M105</strong>: Report Temperatures</a></li> <li><a href="/docs/gcode/M106.html"><strong>M106</strong>: Set Fan Speed</a></li> <li><a href="/docs/gcode/M107.html"><strong>M107</strong>: Fan Off</a></li> <li><a href="/docs/gcode/M108.html"><strong>M108</strong>: Break and Continue</a></li> <li><a href="/docs/gcode/M109.html"><strong>M109</strong>: Wait for Hotend Temperature</a></li> <li><a href="/docs/gcode/M110.html"><strong>M110</strong>: Set Line Number</a></li> <li><a href="/docs/gcode/M111.html"><strong>M111</strong>: Debug Level</a></li> <li><a href="/docs/gcode/M112.html"><strong>M112</strong>: Full Shutdown</a></li> <li><a href="/docs/gcode/M113.html"><strong>M113</strong>: Host Keepalive</a></li> <li><a href="/docs/gcode/M114.html"><strong>M114</strong>: Get Current Position</a></li> <li><a href="/docs/gcode/M115.html"><strong>M115</strong>: Firmware Info</a></li> <li><a href="/docs/gcode/M117.html"><strong>M117</strong>: Set LCD Message</a></li> <li><a href="/docs/gcode/M118.html"><strong>M118</strong>: Serial print</a></li> <li><a href="/docs/gcode/M119.html"><strong>M119</strong>: Endstop States</a></li> <li><a href="/docs/gcode/M120.html"><strong>M120</strong>: Enable Endstops</a></li> <li><a href="/docs/gcode/M121.html"><strong>M121</strong>: Disable Endstops</a></li> <li><a href="/docs/gcode/M122.html"><strong>M122</strong>: TMC Debugging</a></li> <li><a href="/docs/gcode/M123.html"><strong>M123</strong>: Fan Tachometers</a></li> <li><a href="/docs/gcode/M125.html"><strong>M125</strong>: Park Head</a></li> <li><a href="/docs/gcode/M126.html"><strong>M126</strong>: Baricuda 1 Open</a></li> <li><a href="/docs/gcode/M127.html"><strong>M127</strong>: Baricuda 1 Close</a></li> <li><a href="/docs/gcode/M128.html"><strong>M128</strong>: Baricuda 2 Open</a></li> <li><a href="/docs/gcode/M129.html"><strong>M129</strong>: Baricuda 2 Close</a></li> <li><a href="/docs/gcode/M140.html"><strong>M140</strong>: Set Bed Temperature</a></li> <li><a href="/docs/gcode/M141.html"><strong>M141</strong>: Set Chamber Temperature</a></li> <li><a href="/docs/gcode/M143.html"><strong>M143</strong>: Set Laser Cooler Temperature</a></li> <li><a href="/docs/gcode/M145.html"><strong>M145</strong>: Set Material Preset</a></li> <li><a href="/docs/gcode/M149.html"><strong>M149</strong>: Set Temperature Units</a></li> <li><a href="/docs/gcode/M150.html"><strong>M150</strong>: Set RGB(W) Color</a></li> <li><a href="/docs/gcode/M154.html"><strong>M154</strong>: Position Auto-Report</a></li> <li><a href="/docs/gcode/M155.html"><strong>M155</strong>: Temperature Auto-Report</a></li> <li><a href="/docs/gcode/M163.html"><strong>M163</strong>: Set Mix Factor</a></li> <li><a href="/docs/gcode/M164.html"><strong>M164</strong>: Save Mix</a></li> <li><a href="/docs/gcode/M165.html"><strong>M165</strong>: Set Mix</a></li> <li><a href="/docs/gcode/M166.html"><strong>M166</strong>: Gradient Mix</a></li> <li><a href="/docs/gcode/M190.html"><strong>M190</strong>: Wait for Bed Temperature</a></li> <li><a href="/docs/gcode/M191.html"><strong>M191</strong>: Wait for Chamber Temperature</a></li> <li><a href="/docs/gcode/M192.html"><strong>M192</strong>: Wait for Probe temperature</a></li> <li><a href="/docs/gcode/M193.html"><strong>M193</strong>: Set Laser Cooler Temperature</a></li> <li><a href="/docs/gcode/M200.html"><strong>M200</strong>: Set Filament Diameter</a></li> <li><a href="/docs/gcode/M201.html"><strong>M201</strong>: Print / Travel Move Limits</a></li> <li><a href="/docs/gcode/M203.html"><strong>M203</strong>: Set Max Feedrate</a></li> <li><a href="/docs/gcode/M204.html"><strong>M204</strong>: Set Starting Acceleration</a></li> <li><a href="/docs/gcode/M205.html"><strong>M205</strong>: Set Advanced Settings</a></li> <li><a href="/docs/gcode/M206.html"><strong>M206</strong>: Set Home Offsets</a></li> <li><a href="/docs/gcode/M207.html"><strong>M207</strong>: Set Firmware Retraction</a></li> <li><a href="/docs/gcode/M208.html"><strong>M208</strong>: Firmware Recover</a></li> <li><a href="/docs/gcode/M209.html"><strong>M209</strong>: Set Auto Retract</a></li> <li><a href="/docs/gcode/M211.html"><strong>M211</strong>: Software Endstops</a></li> <li><a href="/docs/gcode/M217.html"><strong>M217</strong>: Filament swap parameters</a></li> <li><a href="/docs/gcode/M218.html"><strong>M218</strong>: Set Hotend Offset</a></li> <li><a href="/docs/gcode/M220.html"><strong>M220</strong>: Set Feedrate Percentage</a></li> <li><a href="/docs/gcode/M221.html"><strong>M221</strong>: Set Flow Percentage</a></li> <li><a href="/docs/gcode/M226.html"><strong>M226</strong>: Wait for Pin State</a></li> <li><a href="/docs/gcode/M240.html"><strong>M240</strong>: Trigger Camera</a></li> <li><a href="/docs/gcode/M250.html"><strong>M250</strong>: LCD Contrast</a></li> <li><a href="/docs/gcode/M255.html"><strong>M255</strong>: LCD Sleep/Backlight Timeout</a></li> <li><a href="/docs/gcode/M256.html"><strong>M256</strong>: LCD Brightness</a></li> <li><a href="/docs/gcode/M260.html"><strong>M260</strong>: I2C Send</a></li> <li><a href="/docs/gcode/M261.html"><strong>M261</strong>: I2C Request</a></li> <li><a href="/docs/gcode/M280.html"><strong>M280</strong>: Servo Position</a></li> <li><a href="/docs/gcode/M281.html"><strong>M281</strong>: Edit Servo Angles</a></li> <li><a href="/docs/gcode/M282.html"><strong>M282</strong>: Detach Servo</a></li> <li><a href="/docs/gcode/M290.html"><strong>M290</strong>: Babystep</a></li> <li><a href="/docs/gcode/M300.html"><strong>M300</strong>: Play Tone</a></li> <li><a href="/docs/gcode/M301.html"><strong>M301</strong>: Set Hotend PID</a></li> <li><a href="/docs/gcode/M302.html"><strong>M302</strong>: Cold Extrude</a></li> <li><a href="/docs/gcode/M303.html"><strong>M303</strong>: PID autotune</a></li> <li><a href="/docs/gcode/M304.html"><strong>M304</strong>: Set Bed PID</a></li> <li><a href="/docs/gcode/M305.html"><strong>M305</strong>: User Thermistor Parameters</a></li> <li><a href="/docs/gcode/M306.html"><strong>M306</strong>: Model Predictive Temp. Control</a></li> <li><a href="/docs/gcode/M350.html"><strong>M350</strong>: Set micro-stepping</a></li> <li><a href="/docs/gcode/M351.html"><strong>M351</strong>: Set Microstep Pins</a></li> <li><a href="/docs/gcode/M355.html"><strong>M355</strong>: Case Light Control</a></li> <li><a href="/docs/gcode/M360.html"><strong>M360</strong>: SCARA Theta A</a></li> <li><a href="/docs/gcode/M361.html"><strong>M361</strong>: SCARA Theta-B</a></li> <li><a href="/docs/gcode/M362.html"><strong>M362</strong>: SCARA Psi-A</a></li> <li><a href="/docs/gcode/M363.html"><strong>M363</strong>: SCARA Psi-B</a></li> <li><a href="/docs/gcode/M364.html"><strong>M364</strong>: SCARA Psi-C</a></li> <li><a href="/docs/gcode/M380.html"><strong>M380</strong>: Activate Solenoid</a></li> <li><a href="/docs/gcode/M381.html"><strong>M381</strong>: Deactivate Solenoids</a></li> <li><a href="/docs/gcode/M400.html"><strong>M400</strong>: Finish Moves</a></li> <li><a href="/docs/gcode/M401.html"><strong>M401</strong>: Deploy Probe</a></li> <li><a href="/docs/gcode/M402.html"><strong>M402</strong>: Stow Probe</a></li> <li><a href="/docs/gcode/M403.html"><strong>M403</strong>: MMU2 Filament Type</a></li> <li><a href="/docs/gcode/M404.html"><strong>M404</strong>: Set Filament Diameter</a></li> <li><a href="/docs/gcode/M405.html"><strong>M405</strong>: Filament Width Sensor On</a></li> <li><a href="/docs/gcode/M406.html"><strong>M406</strong>: Filament Width Sensor Off</a></li> <li><a href="/docs/gcode/M407.html"><strong>M407</strong>: Filament Width</a></li> <li><a href="/docs/gcode/M410.html"><strong>M410</strong>: Quickstop</a></li> <li><a href="/docs/gcode/M412.html"><strong>M412</strong>: Filament Runout</a></li> <li><a href="/docs/gcode/M413.html"><strong>M413</strong>: Power-loss Recovery</a></li> <li><a href="/docs/gcode/M420.html"><strong>M420</strong>: Bed Leveling State</a></li> <li><a href="/docs/gcode/M421.html"><strong>M421</strong>: Set Mesh Value</a></li> <li><a href="/docs/gcode/M422.html"><strong>M422</strong>: Set Z Motor XY</a></li> <li><a href="/docs/gcode/M423.html"><strong>M423</strong>: X Twist Compensation</a></li> <li><a href="/docs/gcode/M425.html"><strong>M425</strong>: Backlash compensation</a></li> <li><a href="/docs/gcode/M428.html"><strong>M428</strong>: Home Offsets Here</a></li> <li><a href="/docs/gcode/M430.html"><strong>M430</strong>: Power Monitor</a></li> <li><a href="/docs/gcode/M486.html"><strong>M486</strong>: Cancel Objects</a></li> <li><a href="/docs/gcode/M493.html"><strong>M493</strong>: Fixed-Time Motion</a></li> <li><a href="/docs/gcode/M500.html"><strong>M500</strong>: Save Settings</a></li> <li><a href="/docs/gcode/M501.html"><strong>M501</strong>: Restore Settings</a></li> <li><a href="/docs/gcode/M502.html"><strong>M502</strong>: Factory Reset</a></li> <li><a href="/docs/gcode/M503.html"><strong>M503</strong>: Report Settings</a></li> <li><a href="/docs/gcode/M504.html"><strong>M504</strong>: Validate EEPROM contents</a></li> <li><a href="/docs/gcode/M510.html"><strong>M510</strong>: Lock Machine</a></li> <li><a href="/docs/gcode/M511.html"><strong>M511</strong>: Unlock Machine</a></li> <li><a href="/docs/gcode/M512.html"><strong>M512</strong>: Set Passcode</a></li> <li><a href="/docs/gcode/M524.html"><strong>M524</strong>: Abort SD print</a></li> <li><a href="/docs/gcode/M540.html"><strong>M540</strong>: Endstops Abort SD</a></li> <li><a href="/docs/gcode/M569.html"><strong>M569</strong>: Set TMC stepping mode</a></li> <li><a href="/docs/gcode/M575.html"><strong>M575</strong>: Serial baud rate</a></li> <li><a href="/docs/gcode/M592.html"><strong>M592</strong>: Nonlinear Extrusion Control</a></li> <li><a href="/docs/gcode/M593.html"><strong>M593</strong>: ZV Input Shaping</a></li> <li><a href="/docs/gcode/M600.html"><strong>M600</strong>: Filament Change</a></li> <li><a href="/docs/gcode/M603.html"><strong>M603</strong>: Configure Filament Change</a></li> <li><a href="/docs/gcode/M605.html"><strong>M605</strong>: Multi Nozzle Mode</a></li> <li><a href="/docs/gcode/M665.html"><strong>M665</strong>: Delta Configuration</a></li> <li><a href="/docs/gcode/M665-scara.html"><strong>M665</strong>: SCARA Configuration</a></li> <li><a href="/docs/gcode/M666.html"><strong>M666</strong>: Set Delta endstop adjustments</a></li> <li><a href="/docs/gcode/M666-dual.html"><strong>M666</strong>: Set dual endstop offsets</a></li> <li><a href="/docs/gcode/M672.html"><strong>M672</strong>: Duet Smart Effector sensitivity</a></li> <li><a href="/docs/gcode/M701.html"><strong>M701</strong>: Load filament</a></li> <li><a href="/docs/gcode/M702.html"><strong>M702</strong>: Unload filament</a></li> <li><a href="/docs/gcode/M710.html"><strong>M710</strong>: Controller Fan settings</a></li> <li><a href="/docs/gcode/M808.html"><strong>M808</strong>: Repeat Marker</a></li> <li><a href="/docs/gcode/M810-M819.html"><strong>M810-M819</strong>: G-code macros</a></li> <li><a href="/docs/gcode/M851.html"><strong>M851</strong>: XYZ Probe Offset</a></li> <li><a href="/docs/gcode/M852.html"><strong>M852</strong>: Bed Skew Compensation</a></li> <li><a href="/docs/gcode/M860-M869.html"><strong>M860-M869</strong>: I2C Position Encoders</a></li> <li><a href="/docs/gcode/M871.html"><strong>M871</strong>: Probe temperature config</a></li> <li><a href="/docs/gcode/M876.html"><strong>M876</strong>: Handle Prompt Response</a></li> <li><a href="/docs/gcode/M900.html"><strong>M900</strong>: Linear Advance Factor</a></li> <li><a href="/docs/gcode/M906.html"><strong>M906</strong>: Stepper Motor Current</a></li> <li><a href="/docs/gcode/M907.html"><strong>M907</strong>: Set Motor Current</a></li> <li><a href="/docs/gcode/M908.html"><strong>M908</strong>: Set Trimpot Pins</a></li> <li><a href="/docs/gcode/M909.html"><strong>M909</strong>: DAC Print Values</a></li> <li><a href="/docs/gcode/M910.html"><strong>M910</strong>: Commit DAC to EEPROM</a></li> <li><a href="/docs/gcode/M911.html"><strong>M911</strong>: TMC OT Pre-Warn Condition</a></li> <li><a href="/docs/gcode/M912.html"><strong>M912</strong>: Clear TMC OT Pre-Warn</a></li> <li><a href="/docs/gcode/M913.html"><strong>M913</strong>: Set Hybrid Threshold Speed</a></li> <li><a href="/docs/gcode/M914.html"><strong>M914</strong>: TMC Bump Sensitivity</a></li> <li><a href="/docs/gcode/M915.html"><strong>M915</strong>: TMC Z axis calibration</a></li> <li><a href="/docs/gcode/M916.html"><strong>M916</strong>: L6474 Thermal Warning Test</a></li> <li><a href="/docs/gcode/M917.html"><strong>M917</strong>: L6474 Overcurrent Warning Test</a></li> <li><a href="/docs/gcode/M918.html"><strong>M918</strong>: L6474 Speed Warning Test</a></li> <li><a href="/docs/gcode/M919.html"><strong>M919</strong>: TMC Chopper Timing</a></li> <li><a href="/docs/gcode/M928.html"><strong>M928</strong>: Start SD Logging</a></li> <li><a href="/docs/gcode/M951.html"><strong>M951</strong>: Magnetic Parking Extruder</a></li> <li><a href="/docs/gcode/M993.html"><strong>M993</strong>: Back up flash settings to SD</a></li> <li><a href="/docs/gcode/M994.html"><strong>M994</strong>: Restore flash from SD</a></li> <li><a href="/docs/gcode/M995.html"><strong>M995</strong>: Touch Screen Calibration</a></li> <li><a href="/docs/gcode/M997.html"><strong>M997</strong>: Firmware update</a></li> <li><a href="/docs/gcode/M999.html"><strong>M999</strong>: STOP Restart</a></li> <li><a href="/docs/gcode/M7219.html"><strong>M7219</strong>: MAX7219 Control</a></li> <li><a href="/docs/gcode/T.html"><strong>T0-T7</strong>: Select or Report Tool</a></li> <li><a href="/docs/gcode/T-mmu2.html"><strong>T?-Tx</strong>: MMU2 Special Commands</a></li> </ul> </li> <li class="dropdown-submenu hardware"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Hardware</a> <ul class="dropdown-menu"> <li><a href="/meta/hardware/">All documents</a></li> <li class="divider"> <li><a href="/docs/hardware/boards.html">Boards</a></li> <li><a href="/docs/hardware/controllers.html">Controllers and displays</a></li> <li class="divider"> <li><a href="/docs/hardware/endstops.html">Endstops</a></li> <li><a href="/docs/hardware/tmc_drivers.html">Trinamic drivers</a></li> </ul> </li> <li class="dropdown-submenu setting"> <a href="#" class="dropdown-toggle" data-toggle="dropdown">Settings</a> <ul class="dropdown-menu"> <li><a href="/meta/setting/">All documents</a></li> <li class="divider"> <li><a href="/docs/setting/config_info.html">Configuration Info</a></li> <li><a href="/docs/setting/extruder.html">Extruders</a></li> <li><a href="/docs/setting/hardware.html">Hardware</a></li> <li><a href="/docs/setting/machine_info.html">Machine Info</a></li> <li><a href="/docs/setting/stepper_drivers.html">Stepper Drivers</a></li> <li><a href="/docs/setting/temperature.html">Temperature</a></li> </ul> </li> <li><a href="/docs/basics/troubleshooting.html">Troubleshooting</a></li> <li class="divider"> <li><a href="/meta/in-review/">Documentation Needing Review</a></li> </ul> </li> <li id="top-donate"><a href="/docs/development/contributing.html#donate">❤️ Donate</a></li> <li id="searchbox"> <form action="/meta/search/"> <input type="search" name="q" placeholder="Search"> </form> </li> </ul> <ul class="nav navbar-right hidden-sm"> <li> <a href="https://github.com/MarlinFirmware/MarlinDocumentation/edit/master/_development/code_structure.md" data-proofer-ignore><i class="fa fa-pen-to-square" aria-hidden="true"></i> <span>Edit Page</span></a> </li> </ul> </div> </div> </nav> <div class="custom-btn"> <div class="row hidden-md hidden-lg hidden-xl"> <a class="btn btn-edit e-btn btn-block btn-lg" href="https://github.com/MarlinFirmware/MarlinDocumentation/edit/master/_development/code_structure.md" data-proofer-ignore role="button"><span class="e-btn-text"><em class="fa fa-pen-to-square" aria-hidden="true"></em>  Edit Page</span></a> </div> <div class="row"> <a class="btn btn-learn e-btn btn-block btn-lg" href="/docs/basics/introduction.html" role="button"> <span class="e-btn-text"><em class="fa fa-book" aria-hidden="true"></em>  Learn more</span></a> </div> <div class="row"> <a class="btn btn-contribute e-btn btn-block btn-lg" href="/docs/development/contributing.html" role="button"> <span class="e-btn-text"><em class="fa fa-users" aria-hidden="true"></em>  Contribute</span></a> </div> <div class="row"> <a class="btn btn-download e-btn btn-block btn-lg" href="/meta/download/" role="button"> <span class="e-btn-text"><em class="fa fa-download" aria-hidden="true"></em>  Download</span></a> </div> <div class="row"> <a class="btn btn-follow e-btn btn-block btn-lg" href="//fosstodon.org/@marlinfirmware" role="button"> <span class="e-btn-text"><em class="fa-brands fa-mastodon" aria-hidden="true"></em>  Follow @MarlinFirmware</span></a> </div> <div class="row"> <a class="btn btn-follow e-btn btn-block btn-lg" href="//twitter.com/marlinfirmware" role="button"> <span class="e-btn-text"><em class="fa-brands fa-x" aria-hidden="true"></em>  Follow @MarlinFirmware</span></a> </div> </div> <div class="container" role="main"> <div class="row"> <div class="col-lg-3 col-md-4 visible-lg-block visible-md-block custom-no-padding"> <div class="custom-fixed-sidebar"> <div id="toc"></div> </div> </div> <div class="col-lg-9 col-md-8"> <div class="row"> <div class="col-md-12 custom-article"> <p id="authors" class="text-right pull-right visible-lg-block hidden-print small custom-pt25"> <a href="//github.com/thinkyhead" data-toggle="tooltip" data-placement="bottom" title="Visit thinkyhead's profile on Github"><img class="avatar avatar-small" alt="thinkyhead" width="30" height="30" data-proofer-ignore="true" src="https://avatars1.githubusercontent.com/thinkyhead?v=3&amp;s=30" srcset="https://avatars1.githubusercontent.com/thinkyhead?v=3&amp;s=30 1x, https://avatars1.githubusercontent.com/thinkyhead?v=3&amp;s=60 2x, https://avatars1.githubusercontent.com/thinkyhead?v=3&amp;s=90 3x, https://avatars1.githubusercontent.com/thinkyhead?v=3&amp;s=120 4x"></a> </p> <h1 class="custom-article-header">Code Structure</h1> <h2 id="marlin-code-overview">Marlin Code Overview</h2> <p>Marlin is a very complex Arduino sketch. It is as complicated for developers to navigate as it is for new users who might want to make a small change. This document is meant to be a concise guide to help you find your way around the Marlin codebase and understand how the program works, at least in principle.</p> <p>This document provides a high level overview of structural details and program flow. By the end you should have an idea where (and how) to find your way around. Other details, such as Marlin coding style, are described in more detail on the <a href="coding_standards.html">Coding Standards</a> page for those who may want to contribute.</p> <h3 id="base-folder-structure">Base Folder Structure</h3> <table class="pretty-list headless"> <thead> <tr> <th>File</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><strong><code class="language-plaintext highlighter-rouge">MarlinFirmware</code></strong></td> <td>The root folder contains only files that need to be here. When you build Marlin with PlatformIO it creates a <code class="language-plaintext highlighter-rouge">.pio</code> folder here, and when working with git in the shell this should be your current work directory.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">buildroot</code></strong></td> <td>Contains helper scripts for developers, font tools, CI tests, Marlin logo art, and other data.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">buildroot/share/PlatformIO</code></strong></td> <td>Board definitions, variants, linker scripts, and build scripts are stored here. This folder is frequently referenced by the build environments in the <code class="language-plaintext highlighter-rouge">ini</code> folder.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">ini</code></strong></td> <td>This folder contains all the PlatformIO environment settings organized by MCU type. The <code class="language-plaintext highlighter-rouge">platformio.ini</code> file pulls these in to provide build / upload / debug settings for PlatformIO. The file <code class="language-plaintext highlighter-rouge">ini/features.ini</code> is used by Marlin’s build scripts to filter out source files that aren’t needed, so the build can finish much more quickly with PlatformIO than with Arduino IDE.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">Marlin</code></strong></td> <td>Primarily, this is where the main configuration files need to be when building Marlin. The <code class="language-plaintext highlighter-rouge">Marlin.ino</code> Arduino project file is here. And, you should <code class="language-plaintext highlighter-rouge">cd Marlin</code> in the shell if you want to do a build with <code class="language-plaintext highlighter-rouge">make</code> (only supported for Arduino IDE-compatible targets).</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">Marlin/src</code></strong></td> <td>Contains the Marlin application (“sketch”). The main program starts with <code class="language-plaintext highlighter-rouge">MarlinCore.cpp</code> which contains the <code class="language-plaintext highlighter-rouge">setup()</code> and <code class="language-plaintext highlighter-rouge">loop()</code> functions that make Marlin an Arduino program. The contents of this folder are described in detail in the next section.</td> </tr> </tbody> </table> <h3 id="the-marlinsrc-folder">The Marlin/src Folder</h3> <p>The <code class="language-plaintext highlighter-rouge">Marlin/src</code> folder contains Marlin’s main source file, <code class="language-plaintext highlighter-rouge">MarlinCore.cpp</code> and the <code class="language-plaintext highlighter-rouge">MarlinCore.h</code> header file. <code class="language-plaintext highlighter-rouge">MarlinCore.cpp</code> contains the <code class="language-plaintext highlighter-rouge">setup()</code> function that initializes the firmware and the <code class="language-plaintext highlighter-rouge">loop()</code> function that continuously runs the program loop.</p> <p>The rest of the source code is divided up into 10 subfolders, and many of these subfolders are divided up further. Here’s a basic overview of each one:</p> <table class="pretty-list headless"> <thead> <tr> <th>File</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><strong><code class="language-plaintext highlighter-rouge">core</code></strong></td> <td>Contains headers that are always needed by other Marlin source files, providing types, macros, serial output, utility functions, etc. Most source files will just include <code class="language-plaintext highlighter-rouge">inc/MarlinConfig.h</code> which ensures these files will be included in their expected order.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">feature</code></strong></td> <td>This folder contains supporting code for optional features. Some features are light and only add a G-code or insert a change into common code. If a feature needs to define a class or a suite of functions, those additional files will go here.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">gcode</code></strong></td> <td>Contains the <code class="language-plaintext highlighter-rouge">GCodeParser</code> class definition, plus all the G-code command implementations (with some exceptions), wrapped in a single class called <code class="language-plaintext highlighter-rouge">GcodeSuite</code>. The G-code implementation files are bundled into sub-folders with several categories. The files named as the G-code so they can be found more quickly using your IDE’s Quick-Open feature.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">HAL</code></strong></td> <td>Each controller family provides functions to control the hardware, but not all controller families use the same interfaces. The <em>Hardware Access Layer</em> defines functions to conceal these differences so the rest of Marlin can be defined more generically. At the time of this writing Marlin has ten distinct HALs.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">inc</code></strong></td> <td>This folder contains essential includes that define the Marlin version, configuration conditionals, checks for obsolete options, and final sanity-checks for reasonable settings. Note that each HAL also contains its own <code class="language-plaintext highlighter-rouge">Conditionals*.h</code> and <code class="language-plaintext highlighter-rouge">SanityCheck.h</code> files.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">lcd</code></strong></td> <td>All the code related to LCDs, TFTs, OLEDs, encoders, buttons, and serial controllers is stored here. Language translation has typically only applied to external controllers so language translations are also stored here.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">libs</code></strong></td> <td>Any general math or hardware library code goes here. So there’s code for the buzzer, crc16 checksums, 3x3 matrices, number-to-string conversion, Heatshrink for binary transfer, and even a couple of EEPROMs.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">module</code></strong></td> <td>All the typical features of the machine are defined here. This includes all the things a 3D printer would have, such as: heaters and sensors, bed probe, endstops, kinematics, high-level motion functions that turn commands into segmented moves, the motion planner that turns mm segments into enqueued stepper blocks with speed changes, and the stepper ISR that turns the block segments into interrupt timings and STEP signals.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">pins</code></strong></td> <td>All of Marlin’s board definitions are in this folder. The boards are divided up mostly by architecture, plus <code class="language-plaintext highlighter-rouge">rambo</code>, <code class="language-plaintext highlighter-rouge">ramps</code>, and <code class="language-plaintext highlighter-rouge">sanguino</code>. Each board has its own unique pins file, included by <code class="language-plaintext highlighter-rouge">pins.h</code> based on the <code class="language-plaintext highlighter-rouge">MOTHERBOARD</code> setting. Since <code class="language-plaintext highlighter-rouge">pins.h</code> is one of the files included by <code class="language-plaintext highlighter-rouge">MarlinConfig.h</code>, it isn’t included elsewhere.</td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">sd</code></strong></td> <td>This is where you’ll find all the high level filesystem code that implements actual files and folders. The <code class="language-plaintext highlighter-rouge">CardReader</code> class is Marlin’s main interface for navigating the directory, opening G-code files, and printing from SD card (or other media). Since Marlin 2.0.8 all media types derive from the <code class="language-plaintext highlighter-rouge">DiskIODriver</code> abstract class.</td> </tr> </tbody> </table> <h3 id="configuration-and-include-tree">Configuration and Include Tree</h3> <p>Marlin is highly configurable. You’ll find many places throughout the source code where configuration options are applied to turn code on and off, change behavior, and provide values.</p> <p>How does a Marlin source file get all the configuration values it needs?</p> <p>To begin with, when you build a C++ program the first stage is to build all the <code class="language-plaintext highlighter-rouge">.c</code> and <code class="language-plaintext highlighter-rouge">.cpp</code> files individually. Each of these files must be complete within itself, and each is responsible to include the headers it requires. This can get tedious in a large project, so a lot of compilers allow you make a “precompiled header” (<code class="language-plaintext highlighter-rouge">.pch</code> file) that includes all your common headers. Marlin doesn’t use a PCH file, but rather, regular headers that work in a similar way.</p> <p>The include order of the headers in the <code class="language-plaintext highlighter-rouge">inc</code>, <code class="language-plaintext highlighter-rouge">core</code>, <code class="language-plaintext highlighter-rouge">HAL</code>, and <code class="language-plaintext highlighter-rouge">pins</code> folders is important because each one builds on its predecessors. To ensure the correct include order is always followed, any code that needs the Configuration and Conditionals files (up to <code class="language-plaintext highlighter-rouge">Conditionals_adv.h</code>) must include <code class="language-plaintext highlighter-rouge">inc/MarlinConfigPre.h</code>, while any code that needs the fully realized hardware configuration must include <code class="language-plaintext highlighter-rouge">inc/MarlinConfig.h</code>.</p> <p>Let’s take a closer look at the headers that each of these files includes.</p> <h4 id="marlinconfigpreh"><code class="language-plaintext highlighter-rouge">MarlinConfigPre.h</code></h4> <table class="pretty-list headless"> <thead> <tr> <th>File</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">&lt;stdint.h&gt;</code></td> <td>This is needed all the time for shorthand integer types.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">HAL/platforms.h</code></td> <td>This file determines the active HAL and provides a macro for doing HAL includes.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/macros.h</code></td> <td>A lot of Marlin is about meta-programming. This file provides precompiler macros used to compile code conditionally.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/boards.h</code></td> <td>Marlin defines the names of all boards in this file, plus a helpful macro to check whether one of a list of boards is enabled.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Configuration.h</code></td> <td>Marlin’s primary configuration file contains settings like the specific motherboard, machine geometry, stepper driver types, heaters and sensors, enabled features, LCD controller, and so on. Pins defined in this file will override defaults.</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">CUSTOM_VERSION_FILE</code> and <code class="language-plaintext highlighter-rouge">Version.h</code> </td> <td>A few settings for the About Screen.</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">inc/Conditionals_LCD.h</code> and <code class="language-plaintext highlighter-rouge">HAL/.../inc/Conditionals_LCD.h</code> </td> <td>The items we call <em>conditionals</em> are simply defines - mostly flags - based on one or more configuration settings. In combination with configured settings conditionals provide hints to the precompiler and the build scripts to refine and optimize the build. For example the <code class="language-plaintext highlighter-rouge">HAS_TOUCH_BUTTONS</code> defined here is used by one of our PlatformIO preprocessor scripts (in combination with <code class="language-plaintext highlighter-rouge">ini/features.ini</code>) to add <code class="language-plaintext highlighter-rouge">src/lcd/touch/touch_buttons.cpp</code> to the build, where normally it would be excluded.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/drivers.h</code></td> <td>This file defines macros to test for available stepper driver features. The stepper drivers have been selected at this point so some conditionals are also defined here for use in <code class="language-plaintext highlighter-rouge">Configuration_adv.h</code> and any other headers that follow.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Configuration_adv.h</code></td> <td>Extended configuration options are defined in this file so you can add more peripherals, tune thermal runaway, set up filament runout parameters, enable debugging, and more.</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">inc/Conditionals_adv.h</code> and <code class="language-plaintext highlighter-rouge">HAL/.../inc/Conditionals_adv.h</code> </td> <td>More conditionals, as described above. These conditionals can make reference to any settings from <code class="language-plaintext highlighter-rouge">Configuration_adv.h</code> plus anything from all the files included so far.</td> </tr> </tbody> </table> <h4 id="marlinconfigh"><code class="language-plaintext highlighter-rouge">MarlinConfig.h</code></h4> <table class="pretty-list headless"> <thead> <tr> <th>File</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">MarlinConfigPre.h</code></td> <td>Everything above is first included.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">HAL/HAL.h</code></td> <td>This header uses defines set by the build tools to figure out the current target platform and architecture, then includes the <code class="language-plaintext highlighter-rouge">HAL.h</code> header of the target platform to declare common HAL interface macros and low-level functions like <code class="language-plaintext highlighter-rouge">HAL_ADC_RANGE</code>, <code class="language-plaintext highlighter-rouge">watchdog_refresh</code>, and <code class="language-plaintext highlighter-rouge">HAL_reboot</code>.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">pins/pins.h</code></td> <td>The master pins file takes care of including the correct pin definitions from <code class="language-plaintext highlighter-rouge">pins/subfolder</code> while also providing helpful hints for the build scripts in its comments. This file also includes version-checking to alert users when board names have changed.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">HAL/.../timers.h</code></td> <td>Timer defines and functions.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">HAL/.../spi_pins.h</code></td> <td>SPI pins are defined based on the MCU family.</td> </tr> <tr> <td> <code class="language-plaintext highlighter-rouge">inc/Conditionals_post.h</code> and <code class="language-plaintext highlighter-rouge">HAL/.../inc/Conditionals_post.h</code> </td> <td>This final conditionals file can test pin definitions along with any other defined values from the headers above.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/types.h</code></td> <td>Defines types and macros for working with XYZE coordinates, celsius temperatures, and so on.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">inc/SanityCheck.h</code></td> <td>This file exists only to check configuration settings and make sure they’re compatible and reasonable, generating error messages to the console for any bad settings or incompatible combinations. The tests at the top of the file check for obsolete options giving error messages that provide basic guidance for upgrading.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">HAL/.../inc/SanityCheck.h</code></td> <td>Each HAL can do its own sanity-check for incompatible options, unimplemented features, etc.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/language.h</code></td> <td>Define all the protocol serial language strings, strings for your selected LCD interface language(s), and helper macros to get translated strings.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/utility.h</code></td> <td>Declare some utility functions like <code class="language-plaintext highlighter-rouge">safe_delay</code>, <code class="language-plaintext highlighter-rouge">serial_delay</code>, and <code class="language-plaintext highlighter-rouge">log_machine_info</code>, plus some useful macros for setting temporary values in block scope.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">core/serial.h</code></td> <td>Define several useful serial output macros and functions, used throughout Marlin for serial output.</td> </tr> </tbody> </table> <h3 id="a-typical-source-file">A Typical Source File</h3> <p>Putting it all together, a typical source file will at least include <code class="language-plaintext highlighter-rouge">MarlinConfigPre.h</code> so that it can check some configuration values up front. Additional headers will be included only if they’re needed. It’s not unusual for some source files to include headers for several features.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * (c) 2021 Marlin Firmware
 * A typical Marlin source.cpp file.
 */</span>
<span class="cp">#include "inc/MarlinConfigPre.h"
</span>
<span class="cp">#if ENABLED(MY_COOL_FEATURE)
</span>
<span class="cp">#if ENABLED(EXTENSIBLE_UI)
</span>  <span class="cp">#include "lcd/extui/ui_api.h"
#endif
</span>
<span class="cp">#endif // MY_COOL_FEATURE
</span></code></pre></div></div> <h3 id="a-typical-header-file">A Typical Header File</h3> <p>Marlin header files aren’t wrapped with <code class="language-plaintext highlighter-rouge">#if</code>…<code class="language-plaintext highlighter-rouge">#endif</code> in the same way as source files. Instead, if a header isn’t needed, then it’s simply never included. Marlin also eschews C-style <code class="language-plaintext highlighter-rouge">#ifdef</code> wrappers and only uses <code class="language-plaintext highlighter-rouge">#pragma once</code> on its own headers.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * (c) 2021 Marlin Firmware
 * A typical Marlin header.h file.
 */</span>
<span class="cp">#pragma once
</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">my_feature_var</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">do_feature_stuff</span><span class="p">();</span>
</code></pre></div></div> <p>Some headers will provide empty functions when the feature is disabled. This makes it easier to turn things off at a single point and can make code neater in other places, but this is used sparingly because it obfuscates what is actually happening.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * (c) 2021 Marlin Firmware
 * A typical Marlin header.h file.
 */</span>
<span class="cp">#pragma once
</span>
<span class="cp">#include "inc/MarlinConfigPre.h"
</span>
<span class="cp">#if ENABLED(MY_COOL_FEATURE)
</span>  <span class="k">extern</span> <span class="kt">int</span> <span class="n">my_feature_var</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">do_feature_stuff</span><span class="p">();</span>
<span class="cp">#else
</span>  <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_feature_stuff</span><span class="p">()</span> <span class="p">{}</span>
<span class="cp">#endif
</span></code></pre></div></div> <h2 id="marlin-build-process">Marlin Build Process</h2> <p>A Marlin build can take a while, but it works like any other sketch. All <code class="language-plaintext highlighter-rouge">.cpp</code> files in Marlin and its dependencies are compiled, plus anything that they include. A Marlin build with PlatformIO uses the files in the <code class="language-plaintext highlighter-rouge">ini</code> folder along with the scripts in <code class="language-plaintext highlighter-rouge">buildroot/share/PlatformIO</code> to filter out unused source files based on your configuration, making it much faster.</p> <h2 id="program-and-command-flow">Program and Command Flow</h2> <p>Marlin program execution begins in <code class="language-plaintext highlighter-rouge">MarlinCore.cpp</code> with initialization in the <code class="language-plaintext highlighter-rouge">setup()</code> function and the main loop in the <code class="language-plaintext highlighter-rouge">loop()</code> function, just like any Arduino sketch. The <code class="language-plaintext highlighter-rouge">loop()</code> function is pretty small and is mainly responsible to call <code class="language-plaintext highlighter-rouge">idle()</code> and then run the next G-code command at the front of the queue when it arrives.</p> <p>Most of the tasks in Marlin are executed out of the <code class="language-plaintext highlighter-rouge">idle</code> function, which calls <code class="language-plaintext highlighter-rouge">manage_inactivity</code> and <code class="language-plaintext highlighter-rouge">thermalManager.manage_heater</code>. You’ll see a lot of calls to <code class="language-plaintext highlighter-rouge">idle</code> because all wait loops use it to keep the machine running. If Marlin ever goes too long without calling <code class="language-plaintext highlighter-rouge">idle</code> the watchdog will get triggered and reset the machine for safety.</p> <p>This program architecture requires some care, since we don’t want some function that gets called by <code class="language-plaintext highlighter-rouge">idle</code> itself calling <code class="language-plaintext highlighter-rouge">idle</code> until the stack blows up. There are only a small number of re-entry guards in Marlin, so in practice it works well.</p> <p>It is pretty straightforward to follow the function calls from <code class="language-plaintext highlighter-rouge">idle</code> to see how Marlin keeps all the devices and features running in the program context. Some features carry on activities all the time, but most of what Marlin does is initiated by G-code commands.</p> <h3 id="interrupt-service-routines">Interrupt Service Routines</h3> <p>Marlin defines a few Interrupt Service Routines (ISRs):</p> <ul> <li>The <strong>Stepper ISR</strong> runs repeatedly, advancing the planner queue and moving the stepper motors at high speed by sending pulses to their STEP and DIR pins. The frequency of this interrupt is tied to the movement speed.</li> <li>The <strong>Temperature ISR</strong> reads the temperature sensors at a frequency close to 1kHz and signals to the main program when the readings are ready. It also manages Software / Slow PWM configured for heaters and fans that don’t need a very high base frequency.</li> <li>The <strong>Endstop ISR</strong> can be activated if the endstop pins are interrupt-capable. It only fires when an endstop pin’s input state changes.</li> <li>The <strong>Tone Timer</strong> is defined by Arduino for some platforms and defined by Marlin for others. It handles pulsing the Piezo buzzer to create tones, and it runs at double the frequency of the current tone.</li> <li>The <strong>Servo Timer</strong> provides PWM signals for servos.</li> </ul> <p>Platforms will also define interrupts for Serial UART and maybe other devices, so Marlin has to be careful choosing the interrupts and timers that it uses.</p> <h3 id="handling-a-g-code">Handling a G-code</h3> <p>Next, let’s look at how a G-code is processed and follow the program flow.</p> <h4 id="0-emergency-parser">0. Emergency Parser</h4> <p>What can you do when the command queue is blocked but the machine needs user input in some form? The emergency parser is a simple state machine that operates at a low level in the serial code watching for certain commands. When it sees <code class="language-plaintext highlighter-rouge">M108</code>, <code class="language-plaintext highlighter-rouge">M112</code>, etc., it takes action right away to handle the code.</p> <h4 id="1-read-from-serial-and-sd">1. Read from Serial and SD</h4> <p>The <code class="language-plaintext highlighter-rouge">manage_inactivity</code> function calls <code class="language-plaintext highlighter-rouge">queue.get_available_commands()</code> which checks the immediate buffer, polls the serial ports, and reads the active SD print file, copying lines into the command queue with the aim to keep it filled.</p> <h4 id="2-pop-a-g-code">2. Pop a G-code</h4> <p>The main <code class="language-plaintext highlighter-rouge">loop()</code> calls <code class="language-plaintext highlighter-rouge">queue.advance()</code> which gets the command at the front of the queue and runs it right away. Marlin won’t come back to <code class="language-plaintext highlighter-rouge">loop()</code> until the command has been completed.</p> <p>Marlin can command itself to do things within the regular command flow and these commands get run by <code class="language-plaintext highlighter-rouge">queue.advance()</code> <em>ahead of the print job queue</em> so they must be used with care.</p> <h4 id="3-prescan-the-g-code">3. Prescan the G-code</h4> <p>Once <code class="language-plaintext highlighter-rouge">queue.advance()</code> has chosen the next command, it calls the parser to pre-process the G-code line. The pre-processor validates the line number and checksum and if all is well it does a quick pre-scan of the parameters before calling the specific G-code handler.</p> <h4 id="4-handle-the-g-code">4. Handle the G-code</h4> <p>All G-code handlers are encapsulated in the <code class="language-plaintext highlighter-rouge">GcodeSuite</code> class (<em>e.g.,</em> <code class="language-plaintext highlighter-rouge">GcodeSuite::G28()</code>) although a few are implemented elsewhere. A G-code handler is a simple void method with no return value. Instead of getting parameters from the function call, it queries the <code class="language-plaintext highlighter-rouge">GCodeParser</code> class to check for parameters and read their values.</p> <p>For example, a handler might use <code class="language-plaintext highlighter-rouge">parser.seenval('X')</code> to check if the <code class="language-plaintext highlighter-rouge">'X'</code> parameter exists and has a value, then call <code class="language-plaintext highlighter-rouge">parser.value_float()</code> to get the value as a float. See <code class="language-plaintext highlighter-rouge">gcode/parser.h</code> for all the available methods.</p> <p>There are hundreds of G-code handlers, so they are split up into individual files by category, with each G-code file only including the headers it needs. All handlers include <code class="language-plaintext highlighter-rouge">gcode.h</code> (which includes <code class="language-plaintext highlighter-rouge">parser.h</code>) so they can process parameters. Other component headers are included as-needed by each G-code handler file.</p> <h4 id="5-command-blocking">5. Command Blocking</h4> <p>Since a G-code command blocks the command queue from advancing until it returns, each command must take care to keep the machine alive during its execution.</p> <p>A <code class="language-plaintext highlighter-rouge">G1</code> command is considered “completed” as soon as the move is enqueued, so it can potentially return right away. In practice, and especially with bed leveling enabled, every linear move has the potential to fill up the planner queue and block while waiting for planner space to open up.</p> <p>When a command needs to wait for something like free space in the planner or user feedback, it calls the <code class="language-plaintext highlighter-rouge">idle</code> function to keep the machine alive and running. The <code class="language-plaintext highlighter-rouge">idle</code> function will even keep reading incoming commands into the queue, but since <code class="language-plaintext highlighter-rouge">idle</code> doesn’t dispatch G-codes or advance the queue, the queue can’t get any emptier until the handler finishes and returns.</p> <h3 id="movement">Movement</h3> <p>Marlin is specialized for movement with stepper motors. These devices allow for precise positioning in a very repeatable and reliable way. You can run print jobs that span several days without losing a single step. The downside to these devices is that the MCU needs to generate precisely-timed signals for every tiny step the motors take. And they require complicated drivers that tend to generate a lot of heat.</p> <p>In its most basic form, a motion command goes through this flow:</p> <p><strong>(1) G-code</strong> -&gt; <strong>(2) Segmented Move</strong> -&gt; <strong>(3) Planner Queue</strong> &lt;-&gt; <strong>(4) Stepper ISR</strong></p> <ol> <li>A movement command specifies a destination position and a nominal feedrate that it would like to achieve. The actual speed will depend on how fast the machine can accelerate and how far the machine will move before it has to change direction.</li> <li>Marlin only does linear moves at the level of the Planner, so commands like <code class="language-plaintext highlighter-rouge">G2</code>/<code class="language-plaintext highlighter-rouge">G3</code>/<code class="language-plaintext highlighter-rouge">G5</code> are converted into several small linear segments. The same goes for Delta and SCARA kinematics and leveled moves. So at this stage Marlin may generate several smaller segments and add them to the Planner Queue.</li> <li>The machine can’t instantly go from a full-stop to a fast move rate, nor can it just instantly stop, so all moves need to be accelerated or decelerated to the requested feedrate. As each move goes into the queue we do a “lookahead” over the entire queue to determine each block’s achievable start and end speeds. Acceleration can be linear or slightly curved. One problem you might encounter is “juddering” on curves. This is caused by small segments completing so quickly that the Planner queue gets emptied out. As a result the machine is forced to decelerate to the minimal “jerk” speed. Marlin can throttle the UI and/or slow down moves to try and prevent this, but it’s not always enough. The simple solution is to configure your slicer to produce longer segments on curves, or to use <code class="language-plaintext highlighter-rouge">G2</code>/<code class="language-plaintext highlighter-rouge">G3</code> arcs.</li> <li>The Stepper ISR is a high priority interrupt routine that obediently fetches and processes the Planner queue until there are no more segments in the queue. Since it produces the actual STEP signals to the stepper motors it may need to run as often as 40,000 times or more per second. In practice we want to run it as often as possible because this improves timing and reduces “aliasing” (i.e., rounding). The Stepper ISR uses the clever and fast <a href="//en.wikipedia.org/wiki/Bresenham's_line_algorithm">Bresenham line algorithm</a> to coordinate the timing of STEP signals. This algorithm benefits from finer resolution, so we get more accurate timing by running the Stepper ISR “as often as possible.”</li> </ol> <h3 id="fixed-time-motion">Fixed-Time Motion</h3> <p>Marlin 2.1.3 introduces Fixed-Time Motion as an alternative method to get more precise step and direction timing along with its own Linear Advance and Input Shaping handlers. Fixed-Time Motion also uses the Stepper ISR to do regular stepping, but it also has a periodic <code class="language-plaintext highlighter-rouge">idle</code> task to handle state changes.</p> <p>Since Fixed-Time motion requires significantly more resources than the standard motion system to pre-calculate its precise pulse timings, it requires a faster processor and more RAM.</p> <p>As this system matures it will likely become default for fast 32-bit boards, but the original motion system will be preserved for slower processors and for simpler motion systems that don’t need the most precise timing.</p> <h3 id="interesting-numbers">Interesting Numbers</h3> <ul> <li>A 1.8° stepper motor has 200 full steps-per-revolution. A 0.9° stepper motor has 400 steps-per-revolution.</li> <li>With the most common 16x micro-stepping that’s 3200 (1.8°) or 6400 (0.9°) micro-steps-per-revolution.</li> <li>X and Y are usually driven with a GT2 (2mm pitch) belt and 20 tooth gear, for 40mm per revolution.</li> <li>This gives you 80 steps-per-millimeter on the X and Y axis. (The Z axis is commonly 400 steps-per-mm.)</li> <li>At 80 steps/mm a modest move speed of 60mm/s on a single axis requires a peak step rate of 4.8kHz.</li> <li>A fast move speed of 200mm/s requires a peak step rate of 16kHz.</li> <li>A very fast move speed of 500mm/s requires a peak step rate of 40kHz.</li> <li>The slowest MCUs are 16MHz AVR. So a 200mm/s move speed needs one step for every 1000 CPU cycles.</li> </ul> </div> </div> </div> </div> </div> <footer> <div class="container shift-footer "> <div class="row"> <div class="col-8"> <p>Brought to you with <i class="fa fa-heart text-danger" aria-hidden="true"></i> lack of <i class="fa fa-bed" aria-hidden="true"></i> and lots of <i class="fa fa-coffee" aria-hidden="true"></i>. <br> The contents of this website are © 2024 under the terms of the <a href="//www.gnu.org/licenses/gpl-3.0.txt">GPLv3</a> License.</p> </div> <div class="col-4"> <div class="pull-right back-to-top"> <a href="#top" data-proofer-ignore> Back to top <i class="fa fa-level-up" aria-hidden="true"></i></a> </div> </div> </div> </div> </footer> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-76230130-1', {
          'cookieDomain': 'marlinfw.org',
          'siteSpeedSampleRate': 80
      });

      ga('require', 'displayfeatures');
      ga('send', 'pageview');
    </script> </body> </html>